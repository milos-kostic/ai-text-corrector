

======================================================================
FILE: tests/test_edge_cases.py
======================================================================

import requests
import json
from datetime import datetime

API_URL = "http://127.0.0.1:5000/correct"
OUTPUT_FILE = "TEST_EDGE_CASES_RESULTS.txt"


def test_correction(text):
    """Test single correction and return result"""
    try:
        r = requests.post(API_URL, json={"text": text}, timeout=10)
        if r.status_code == 200:
            return r.json().get("corrected", "")
        return f"ERROR: {r.status_code}"
    except Exception as e:
        return f"ERROR: {str(e)}"


def main():
    print("\n=== TESTING EDGE CASES ===\n")

    # Test cases: (input, expected_correct, description)
    tests = [
        # ============================================
        # ELLIPSIS CAPITALIZATION TESTS (THE CRITICAL ONES)
        # ============================================
        ("hello... world", "Hello... world", "Ellipsis WITH space - should NOT capitalize 'world'"),
        ("first... second", "First... second", "Ellipsis with space - should NOT capitalize 'second'"),
        ("test... test... test", "Test... test... test", "Multiple ellipsis - only first word capitalized"),
        ("start... middle. end", "Start... middle. End", "Mixed ellipsis and normal period - capitalize after period only"),

        # ============================================
        # NORMAL SENTENCE BOUNDARIES (SHOULD STILL WORK)
        # ============================================
        ("first sentence. second sentence", "First sentence. Second sentence", "Normal sentence boundaries - SHOULD capitalize"),
        ("end. start", "End. Start", "Single dot with space - SHOULD capitalize"),
        ("what? really", "What? Really", "Single question with space - SHOULD capitalize"),
        ("stop! now", "Stop! Now", "Single exclamation with space - SHOULD capitalize"),

        # ============================================
        # COMPACT PUNCTUATION (NO SPACE)
        # ============================================
        ("word...word", "Word...word", "3 dots without space - preserve ellipsis"),
        ("word....word", "Word...word", "4 dots without space - collapse to 3"),
        ("hello!!world", "Hello!world", "2 exclamation without space - collapse to 1"),
        ("what??really", "What?really", "2 question without space - collapse to 1"),
        ("hello.world", "Hello.world", "Single dot without space - should NOT capitalize"),

        # ============================================
        # EMOJI WITH PUNCTUATION
        # ============================================
        ("hello!üòÉworld", "Hello!üòÉworld", "Emoji after exclamation - should NOT capitalize"),
        ("what?üòÇreally", "What?üòÇreally", "Emoji after question - should NOT capitalize"),
        ("hello.üòäworld", "Hello.üòäworld", "Emoji after period - should NOT capitalize"),

        # ============================================
        # MIXED SMART QUOTES AND REGULAR
        # ============================================
        ("It's 'fine'", "It's 'fine'", "Mixed apostrophe and single quotes"),
        ('He said "hello"', 'He said "hello"', "Regular double quotes"),
        ('They said "it\'s ok"', 'They said "it\'s ok"', "Nested quotes with apostrophe - should NOT capitalize 'it'"),

        # ============================================
        # COMPLEX SCENARIOS
        # ============================================
        ("warning!! danger... be careful", "Warning! danger... be careful", "Mixed punctuation types - capitalize only first word"),
        ("first... second. third... fourth", "First... second. Third... fourth", "Complex mixed punctuation"),

        # ============================================
        # EDGE CASES WITH PRESERVED CONTENT
        # ============================================
        ("visit https://example.com... now", "Visit https://example.com... now", "URL with ellipsis - should NOT capitalize 'now'"),
        ("email test@test.com... later", "Email test@test.com... later", "Email with ellipsis - should NOT capitalize 'later'"),
        ("follow #tag... today", "Follow #tag... today", "Hashtag with ellipsis - should NOT capitalize 'today'"),

        # ============================================
        # ZERO-WIDTH CHARACTERS AND WHITESPACE
        # ============================================
        ("he\u200bllo wor\u200bld", "Hello world", "Zero-width characters should be removed"),
        ("hello   world", "Hello world", "Multiple spaces should collapse"),
        ("hello\t\tworld", "Hello world", "Tabs should convert to spaces"),

        # ============================================
        # CAPITALIZATION EDGE CASES
        # ============================================
        ("i am here", "I am here", "Standalone 'i' should capitalize"),
        ("THIS IS ALL CAPS", "This is all caps", "All caps should normalize"),
        ("hElLo WoRLD", "Hello world", "Random casing should fix"),
        ("hello.there", "Hello.there", "Dot without space - no capitalization"),

        # ============================================
        # PUNCTUATION COLLAPSING
        # ============================================
        ("hello!!!! world", "Hello! world", "Multiple exclamation should collapse"),
        ("what???? really", "What? really", "Multiple question should collapse"),
        ("wait..... go", "Wait... go", "Multiple dots (5+) should collapse to 3"),

        # ============================================
        # REAL-WORLD SCENARIOS
        # ============================================
        ("omg... this is amazing!! really?", "Omg... this is amazing! Really?", "Mixed real-world example"),
        ("he said: 'wait... no, stop!'", "He said: 'wait... no, stop!'", "Quotes with ellipsis"),
        ("download from https://site.com... now!", "Download from https://site.com... now!", "URL with ellipsis and exclamation"),
    ]

    results = []
    passed = 0
    failed = 0

    print("Running edge case tests...\n")

    for input_text, expected, description in tests:
        actual = test_correction(input_text)
        is_correct = actual.strip() == expected.strip()

        if is_correct:
            passed += 1
            status = "‚úÖ PASS"
        else:
            failed += 1
            status = "‚ùå FAIL"

        result = {
            "status": status,
            "description": description,
            "input": input_text,
            "expected": expected,
            "actual": actual,
            "correct": is_correct
        }

        results.append(result)

        # Show all results, but highlight failures
        if not is_correct:
            print(f"{status} | {description}")
            print(f"         Input:    '{input_text}'")
            print(f"         Expected: '{expected}'")
            print(f"         Actual:   '{actual}'")
            print()
        else:
            print(f"{status} | {description}")

    # Summary and analysis
    print("\n" + "="*50)
    print("üìä TEST SUMMARY")
    print("="*50)

    success_rate = round(passed / len(tests) * 100, 2)
    print(f"TOTAL: {len(tests)} | PASSED: {passed} | FAILED: {failed}")
    print(f"SUCCESS RATE: {success_rate}%")

    # Category analysis
    ellipsis_tests = [r for r in results if "ellipsis" in r["description"].lower()]
    ellipsis_passed = sum(1 for r in ellipsis_tests if r["correct"])

    punctuation_tests = [r for r in results if any(word in r["description"].lower() for word in ["punctuation", "dot", "exclamation", "question"])]
    punctuation_passed = sum(1 for r in punctuation_tests if r["correct"])

    capitalization_tests = [r for r in results if "capital" in r["description"].lower()]
    capitalization_passed = sum(1 for r in capitalization_tests if r["correct"])

    print(f"\nüìà CATEGORY ANALYSIS:")
    print(f"   Ellipsis:       {ellipsis_passed}/{len(ellipsis_tests)} passed")
    print(f"   Punctuation:    {punctuation_passed}/{len(punctuation_tests)} passed")
    print(f"   Capitalization: {capitalization_passed}/{len(capitalization_tests)} passed")

    # Critical failures
    critical_failures = [r for r in results if not r["correct"] and any(word in r["description"].lower() for word in ["ellipsis", "critical", "should not capitalize"])]

    if critical_failures:
        print(f"\nüî¥ CRITICAL FAILURES ({len(critical_failures)}):")
        for fail in critical_failures[:5]:  # Show first 5
            print(f"   - {fail['description']}")

    # Success assessment
    if success_rate >= 90:
        print("\nüéâ EXCELLENT! Edge cases handled perfectly!")
    elif success_rate >= 80:
        print("\n‚úÖ VERY GOOD! Minor edge cases need attention")
    elif success_rate >= 70:
        print("\n‚ö†Ô∏è  ACCEPTABLE! Some edge cases need work")
    else:
        print("\nüî¥ NEEDS IMPROVEMENT! Significant edge case issues")

    # Save detailed results
    try:
        with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
            f.write(f"=== EDGE CASES TEST RESULTS - {datetime.now()} ===\n")
            f.write(f"TOTAL: {len(tests)} | PASSED: {passed} | FAILED: {failed} | SUCCESS: {success_rate}%\n\n")

            f.write("CATEGORY BREAKDOWN:\n")
            f.write(f"  Ellipsis tests: {ellipsis_passed}/{len(ellipsis_tests)} passed\n")
            f.write(f"  Punctuation tests: {punctuation_passed}/{len(punctuation_tests)} passed\n")
            f.write(f"  Capitalization tests: {capitalization_passed}/{len(capitalization_tests)} passed\n\n")

            f.write("DETAILED RESULTS:\n")
            f.write("="*80 + "\n")

            for r in results:
                f.write(f"\n{r['status']} | {r['description']}\n")
                f.write(f"Input:    '{r['input']}'\n")
                f.write(f"Expected: '{r['expected']}'\n")
                f.write(f"Actual:   '{r['actual']}'\n")
                f.write(f"Correct:  {r['correct']}\n")
                f.write("-" * 40 + "\n")

        print(f"\nüìÑ Full results saved to: {OUTPUT_FILE}")

    except Exception as e:
        print(f"\n‚ùå ERROR saving results: {e}")

    # Final recommendation
    print(f"\nüí° RECOMMENDATION: ", end="")
    if success_rate >= 85:
        print("Edge case handling is solid. Focus on maintaining this level.")
    elif success_rate >= 70:
        print("Address the critical failures first, then minor edge cases.")
    else:
        print("Priority should be fixing ellipsis and basic punctuation handling.")


if __name__ == "__main__":
    main()

======================================================================
FILE: tests/test_i_capitalization.py
======================================================================

"""
test_i_capitalization.py
=========================
COMPREHENSIVE TEST: lowercase "i" ‚Üí uppercase "I" correction

English rule: First person pronoun "I" is ALWAYS capitalized.

Extended test coverage:
- Basic standalone "i"
- Contractions (i'm, i'll, i've, i'd)
- Multiple "i" in complex sentences
- "i" with various punctuation
- Edge cases and false positives
- Real user chat patterns
- Performance with long texts
- Contextual challenges
"""

import requests
import json
import time
from datetime import datetime

API_URL = "http://127.0.0.1:5000/correct"


def test_correction(input_text, expected_output, description):
    """Test single correction with timing"""
    start_time = time.time()
    try:
        r = requests.post(API_URL, json={"text": input_text}, timeout=10)

        if r.status_code != 200:
            return {
                "description": description,
                "input": input_text,
                "expected": expected_output,
                "actual": f"ERROR {r.status_code}: {r.text}",
                "passed": False,
                "response_time": round((time.time() - start_time) * 1000, 2)
            }

        actual = r.json().get("corrected", "")
        passed = actual.strip() == expected_output.strip()

        return {
            "description": description,
            "input": input_text,
            "expected": expected_output,
            "actual": actual,
            "passed": passed,
            "response_time": round((time.time() - start_time) * 1000, 2)
        }

    except Exception as e:
        return {
            "description": description,
            "input": input_text,
            "expected": expected_output,
            "actual": f"EXCEPTION: {str(e)}",
            "passed": False,
            "response_time": round((time.time() - start_time) * 1000, 2)
        }


def print_test_result(result, show_details=True):
    """Print individual test result"""
    status = "‚úÖ" if result["passed"] else "‚ùå"
    print(f"{status} {result['description']}")

    if not result["passed"] and show_details:
        print(f"   Input:    '{result['input']}'")
        print(f"   Expected: '{result['expected']}'")
        print(f"   Actual:   '{result['actual']}'")
        if result["response_time"] > 100:
            print(f"   ‚è±Ô∏è  Slow: {result['response_time']}ms")


def run_test_suite(suite_name, tests, results):
    """Run a suite of tests"""
    print(f"\nüìå {suite_name}\n")
    print("-" * 50)

    for inp, exp, desc in tests:
        result = test_correction(inp, exp, desc)
        results.append(result)
        print_test_result(result)

    return results


def main():
    print("\n" + "=" * 70)
    print("üîç COMPREHENSIVE LOWERCASE 'i' ‚Üí UPPERCASE 'I' TEST")
    print("=" * 70 + "\n")

    results = []

    # ============================================
    # SUITE 1: BASIC STANDALONE "i"
    # ============================================
    basic_tests = [
        # Sentence start
        ("i am happy", "I am happy", "i at sentence start"),
        ("i think so", "I think so", "i think ‚Üí I think"),
        ("i dont know", "I don't know", "i + contraction fix"),

        # Simple middle positions
        ("yesterday i went home", "Yesterday I went home", "i in middle"),
        ("when i was young", "When I was young", "when i ‚Üí when I"),
        ("but i dont care", "But I don't care", "but i ‚Üí but I"),
        ("so i decided", "So I decided", "so i ‚Üí so I"),
        ("then i left", "Then I left", "then i ‚Üí then I"),

        # With common verbs
        ("i have a car", "I have a car", "i have"),
        ("i want to go", "I want to go", "i want"),
        ("i need help", "I need help", "i need"),
        ("i like pizza", "I like pizza", "i like"),
        ("i can do it", "I can do it", "i can"),
    ]

    results = run_test_suite("Test 1: Basic Standalone 'i'", basic_tests, results)

    # ============================================
    # SUITE 2: PUNCTUATION CONTEXTS
    # ============================================
    punctuation_tests = [
        # After sentence-ending punctuation
        ("hello. i am here", "Hello. I am here", "i after period"),
        ("really? i agree", "Really? I agree", "i after question mark"),
        ("stop! i mean it", "Stop! I mean it", "i after exclamation"),

        # After commas and mid-sentence punctuation
        ("yes, i understand", "Yes, I understand", "i after comma"),
        ("well, i think so", "Well, I think so", "i after comma + well"),
        ("ok, i will go", "Ok, I will go", "i after comma + ok"),
        ("no, i dont", "No, I don't", "i after comma + no"),

        # With quotation marks
        ('he said "i know"', 'He said "I know"', 'i in quotes'),
        ("'i am here' she said", "'I am here' she said", "i in single quotes"),

        # With parentheses
        ("(i think) it's good", "(I think) it's good", "i in parentheses"),
        ("if i go (and i will)", "If I go (and I will)", "multiple i with parens"),
    ]

    results = run_test_suite("Test 2: Punctuation Contexts", punctuation_tests, results)

    # ============================================
    # SUITE 3: CONTRACTIONS
    # ============================================
    contraction_tests = [
        # Basic contractions
        ("i'm happy", "I'm happy", "i'm ‚Üí I'm"),
        ("i'll be there", "I'll be there", "i'll ‚Üí I'll"),
        ("i've seen it", "I've seen it", "i've ‚Üí I've"),
        ("i'd like that", "I'd like that", "i'd ‚Üí I'd"),

        # Contractions in sentences
        ("yesterday i'm told you", "Yesterday I'm told you", "i'm in middle"),
        ("i think i'll go", "I think I'll go", "i + i'll combo"),
        ("i know i've done it", "I know I've done it", "multiple contractions"),
        ("if i'd known", "If I'd known", "i'd in condition"),

        # Negative contractions
        ("i'm not sure", "I'm not sure", "i'm not"),
        ("i won't go", "I won't go", "i won't"),
        ("i can't believe", "I can't believe", "i can't"),
        ("i don't know", "I don't know", "i don't"),
        ("i haven't seen", "I haven't seen", "i haven't"),
    ]

    results = run_test_suite("Test 3: Contractions", contraction_tests, results)

    # ============================================
    # SUITE 4: MULTIPLE "i" IN COMPLEX SENTENCES
    # ============================================
    multiple_i_tests = [
        # Double "i" patterns
        ("i think i am right", "I think I am right", "double i simple"),
        ("i know i should go", "I know I should go", "double i know"),
        ("i wish i could", "I wish I could", "double i wish"),
        ("i feel i need", "I feel I need", "double i feel"),

        # Triple "i" patterns
        ("i think i know i can", "I think I know I can", "triple i"),
        ("i believe i saw i was", "I believe I saw I was", "triple i past"),

        # Complex sentence structures
        ("when i was young i thought i knew everything",
         "When I was young I thought I knew everything",
         "complex triple i"),

        ("i don't know what i should do or where i should go",
         "I don't know what I should do or where I should go",
         "complex multiple i"),

        ("if i go and i think i will then i know i can",
         "If I go and I think I will then I know I can",
         "complex conditional i"),
    ]

    results = run_test_suite("Test 4: Multiple 'i' in Complex Sentences", multiple_i_tests, results)

    # ============================================
    # SUITE 5: EDGE CASES & FALSE POSITIVES
    # ============================================
    edge_case_tests = [
        # Should NOT capitalize (false positives)
        ("iphone is good", "Iphone is good", "iPhone - NOT pronoun"),
        ("in it", "In it", "'in' word - NOT pronoun i"),
        ("idea is good", "Idea is good", "'idea' - NOT pronoun"),
        ("via email", "Via email", "'via' - NOT pronoun"),
        ("india country", "India country", "'India' - proper noun"),
        ("pizza with italian", "Pizza with italian", "'italian' - adjective"),

        # Tricky word boundaries
        ("i.phone", "I.phone", "i.phone - NOT pronoun"),
        ("i-pad", "I-pad", "i-pad - NOT pronoun"),
        ("i think", "I think", "i think - SHOULD capitalize"),

        # Mixed case scenarios
        ("I think i should", "I think I should", "mixed I/i correction"),
        ("i think I should", "I think I should", "mixed i/I normalization"),

        # With numbers and symbols
        ("i have 2 cars", "I have 2 cars", "i with numbers"),
        ("i #love it", "I #love it", "i with hashtag"),
        ("i @someone", "I @someone", "i with mention"),
    ]

    results = run_test_suite("Test 5: Edge Cases & False Positives", edge_case_tests, results)

    # ============================================
    # SUITE 6: REAL USER CHAT PATTERNS
    # ============================================
    chat_pattern_tests = [
        # Common chat mistakes
        ("i think your right", "I think you're right", "i + your/you're"),
        ("i dont know where he goed", "I don't know where he went", "i + grammar"),
        ("i was thinking i should go", "I was thinking I should go", "double i thinking"),
        ("yesterday i go to store", "Yesterday I went to store", "i + tense"),

        # Informal speech patterns
        ("omg i cant believe it", "Omg I can't believe it", "i + omg"),
        ("lol i know right", "Lol I know right", "i + lol"),
        ("btw i think so", "Btw I think so", "i + btw"),

        # Question patterns
        ("why i should go", "Why I should go", "why i - tricky case"),
        ("how i can help", "How I can help", "how i - tricky case"),
        ("when i can come", "When I can come", "when i - should capitalize"),

        # With slang and abbreviations
        ("imo i think its good", "Imo I think it's good", "i + imo"),
        ("tbh i dont care", "Tbh I don't care", "i + tbh"),
        ("idk i guess so", "Idk I guess so", "i + idk"),
    ]

    results = run_test_suite("Test 6: Real User Chat Patterns", chat_pattern_tests, results)

    # ============================================
    # SUITE 7: PERFORMANCE & LONG TEXTS
    # ============================================
    performance_tests = [
        # Longer paragraphs with multiple "i"
        ("i think i should tell you that i have been thinking about this for a while and i believe i know what i want to do. i hope you understand that i need to make this decision myself because i feel i am old enough to know what i am doing.",
         "I think I should tell you that I have been thinking about this for a while and I believe I know what I want to do. I hope you understand that I need to make this decision myself because I feel I am old enough to know what I am doing.",
         "long paragraph with multiple i"),

        # Mixed content with URLs and special formats
        ("i visited https://example.com yesterday and i think i found what i was looking for. i also checked my email at test@test.com and i think i got the confirmation i needed.",
         "I visited https://example.com yesterday and I think I found what I was looking for. I also checked my email at test@test.com and I think I got the confirmation I needed.",
         "mixed content with URLs and emails"),
    ]

    results = run_test_suite("Test 7: Performance & Long Texts", performance_tests, results)

    # ============================================
    # SUITE 8: CONTEXTUAL CHALLENGES
    # ============================================
    contextual_tests = [
        # With other grammar corrections
        ("i were wrong", "I was wrong", "i were ‚Üí I was"),
        ("me and i was there", "I and I were there", "pronoun + i combo"),
        ("i is happy", "I am happy", "i is ‚Üí I am"),
        ("i has a car", "I have a car", "i has ‚Üí I have"),

        # Complex grammatical structures
        ("between you and i", "Between you and I", "between you and i"),
        ("it was i who called", "It was I who called", "it was i"),
        ("i myself think", "I myself think", "i myself"),

        # With prepositions and conjunctions
        ("for i know", "For I know", "for i"),
        ("and i think", "And I think", "and i"),
        ("or i could", "Or I could", "or i"),
        ("but i thought", "But I thought", "but i"),
    ]

    results = run_test_suite("Test 8: Contextual Challenges", contextual_tests, results)

    # ============================================
    # SUMMARY & ANALYSIS
    # ============================================
    print("\n" + "=" * 70)

    passed = sum(1 for r in results if r["passed"])
    total = len(results)
    success_rate = round((passed / total) * 100, 2)

    slow_tests = [r for r in results if r["response_time"] > 100]
    failed_tests = [r for r in results if not r["passed"]]

    print(f"üìä COMPREHENSIVE RESULTS: {passed}/{total} passed ({success_rate}%)")

    # Category breakdown
    categories = {
        "Basic Standalone": results[0:15],
        "Punctuation": results[15:30],
        "Contractions": results[30:45],
        "Multiple i": results[45:55],
        "Edge Cases": results[55:70],
        "Chat Patterns": results[70:85],
        "Performance": results[85:87],
        "Contextual": results[87:]
    }

    print(f"\nüìà CATEGORY BREAKDOWN:")
    for name, tests in categories.items():
        cat_passed = sum(1 for t in tests if t["passed"])
        cat_total = len(tests)
        cat_rate = round((cat_passed / cat_total) * 100, 2) if cat_total > 0 else 0
        print(f"   {name:<15} {cat_passed:2d}/{cat_total:2d} ({cat_rate:5.1f}%)")

    # Performance analysis
    avg_time = sum(r["response_time"] for r in results) / len(results)
    print(f"\n‚è±Ô∏è  PERFORMANCE:")
    print(f"   Average response time: {avg_time:.1f}ms")
    print(f"   Slow tests (>100ms): {len(slow_tests)}")

    if failed_tests:
        print(f"\n‚ùå FAILED TESTS ({len(failed_tests)}):")
        for test in failed_tests[:5]:  # Show first 5 failures
            print(f"   - {test['description']}")
        if len(failed_tests) > 5:
            print(f"   ... and {len(failed_tests) - 5} more")

    print("\n" + "=" * 70)

    if success_rate == 100:
        print("üéâ PERFECT! ALL 'i' CAPITALIZATIONS WORKING")
    elif success_rate >= 95:
        print("‚úÖ EXCELLENT! Almost all 'i' capitalizations working")
    elif success_rate >= 85:
        print("‚ö†Ô∏è  GOOD! Most 'i' capitalizations work - minor fixes needed")
    else:
        print("‚ùå NEEDS WORK! Significant 'i' capitalization issues")

    print("=" * 70 + "\n")

    # Save detailed results
    output_data = {
        "timestamp": datetime.now().isoformat(),
        "summary": {
            "total_tests": total,
            "passed": passed,
            "success_rate": success_rate,
            "performance": {
                "average_response_time_ms": round(avg_time, 2),
                "slow_tests_count": len(slow_tests),
                "failed_tests_count": len(failed_tests)
            }
        },
        "category_breakdown": {
            name: {
                "passed": sum(1 for t in tests if t["passed"]),
                "total": len(tests),
                "success_rate": round((sum(1 for t in tests if t["passed"]) / len(tests)) * 100, 2) if len(tests) > 0 else 0
            }
            for name, tests in categories.items()
        },
        "failed_tests": [
            {
                "description": t["description"],
                "input": t["input"],
                "expected": t["expected"],
                "actual": t["actual"],
                "response_time": t["response_time"]
            }
            for t in failed_tests
        ],
        "slow_tests": [
            {
                "description": t["description"],
                "response_time": t["response_time"]
            }
            for t in slow_tests if t["response_time"] > 200
        ],
        "all_results": results
    }

    with open("I_CAPITALIZATION_TEST.json", "w", encoding="utf-8") as f:
        json.dump(output_data, f, indent=2, ensure_ascii=False)

    print("üíæ Detailed results saved to: I_CAPITALIZATION_TEST.json")
    print("üìã Failed tests details saved for debugging\n")


def health_check():
    """Verify server is running"""
    try:
        r = requests.get("http://127.0.0.1:5000/health", timeout=5)
        if r.status_code == 200:
            data = r.json()
            if data.get('status') == 'healthy' and data.get('correctors'):
                print("‚úÖ Server is healthy and correctors are loaded")
                return True
        print("‚ùå Server not healthy")
        return False
    except:
        print("‚ùå Server not running at http://127.0.0.1:5000")
        print("   Start it with: python app.py")
        return False


if __name__ == "__main__":
    if not health_check():
        exit(1)

    print("üöÄ Starting comprehensive 'i' capitalization test suite...")
    print("   This will test 100+ different scenarios")
    print("   Please wait...\n")

    main()

======================================================================
FILE: tests/test_grammar_heuristics.py
======================================================================

"""
test_grammar_heuristics.py
===========================
Targeted test for specific grammar rules:
1. is/are agreement (this/that/these/those)
2. Missing articles (a/an before adjective+noun)

Quick test to verify these mini-heuristics work.
"""

import requests
import json
from datetime import datetime

API_URL = "http://127.0.0.1:5000/correct"


def test_correction(input_text, expected_output, description):
    """Test single correction"""
    try:
        r = requests.post(API_URL, json={"text": input_text}, timeout=5)

        if r.status_code != 200:
            return {
                "description": description,
                "input": input_text,
                "expected": expected_output,
                "actual": f"ERROR {r.status_code}",
                "passed": False
            }

        actual = r.json().get("corrected", "")
        passed = actual.strip() == expected_output.strip()

        return {
            "description": description,
            "input": input_text,
            "expected": expected_output,
            "actual": actual,
            "passed": passed
        }

    except Exception as e:
        return {
            "description": description,
            "input": input_text,
            "expected": expected_output,
            "actual": f"EXCEPTION: {str(e)}",
            "passed": False
        }


def main():
    print("\n" + "=" * 70)
    print("üîç GRAMMAR HEURISTICS TEST - is/are & articles")
    print("=" * 70 + "\n")

    results = []

    # ============================================
    # TEST SET 1: is/are with demonstratives
    # ============================================
    print("üìå Test 1: is/are agreement with this/that/these/those\n")

    is_are_tests = [
        # this/that (singular) + is
        ("this are wrong", "This is wrong", "this + are ‚Üí this + is"),
        ("that are correct", "That is correct", "that + are ‚Üí that + is"),
        ("this were bad", "This was bad", "this + were ‚Üí this + was"),
        ("that were good", "That was good", "that + were ‚Üí that + was"),

        # these/those (plural) + are
        ("these is wrong", "These are wrong", "these + is ‚Üí these + are"),
        ("those is correct", "Those are correct", "those + is ‚Üí those + are"),
        ("these was bad", "These were bad", "these + was ‚Üí these + were"),
        ("those was good", "Those were good", "those + was ‚Üí those + were"),
    ]

    for inp, exp, desc in is_are_tests:
        result = test_correction(inp, exp, desc)
        results.append(result)
        status = "‚úÖ" if result["passed"] else "‚ùå"
        print(f"{status} {desc}")
        if not result["passed"]:
            print(f"   Input:    '{inp}'")
            print(f"   Expected: '{exp}'")
            print(f"   Actual:   '{result['actual']}'")
        print()

    # ============================================
    # TEST SET 2: Missing articles (a/an)
    # ============================================
    print("\nüìå Test 2: Missing articles before adjective + noun\n")

    article_tests = [
        # is + adjective + noun (missing "a")
        ("this is bad sentence", "This is a bad sentence", "is + bad sentence ‚Üí is a bad sentence"),
        ("that is good idea", "That is a good idea", "is + good idea ‚Üí is a good idea"),
        ("it is big problem", "It is a big problem", "is + big problem ‚Üí is a big problem"),

        # was + adjective + noun (missing "a")
        ("this was bad sentence", "This was a bad sentence", "was + bad sentence ‚Üí was a bad sentence"),
        ("it was good idea", "It was a good idea", "was + good idea ‚Üí was a good idea"),

        # Vowel sounds - should add "an"
        ("this is important issue", "This is an important issue", "is + important ‚Üí is an important"),
        ("that was easy task", "That was an easy task", "was + easy ‚Üí was an easy"),
    ]

    for inp, exp, desc in article_tests:
        result = test_correction(inp, exp, desc)
        results.append(result)
        status = "‚úÖ" if result["passed"] else "‚ùå"
        print(f"{status} {desc}")
        if not result["passed"]:
            print(f"   Input:    '{inp}'")
            print(f"   Expected: '{exp}'")
            print(f"   Actual:   '{result['actual']}'")
        print()

    # ============================================
    # TEST SET 3: Combined patterns
    # ============================================
    print("\nüìå Test 3: Combined corrections\n")

    combined_tests = [
        # is/are + missing article
        ("this are bad sentence", "This is a bad sentence", "this are ‚Üí this is + add 'a'"),
        ("these is good idea", "These are a good idea", "these is ‚Üí these are + add 'a'"),

        # Real user mistakes
        ("this are terrible mistake", "This is a terrible mistake", "Real mistake: this are + no article"),
    ]

    for inp, exp, desc in combined_tests:
        result = test_correction(inp, exp, desc)
        results.append(result)
        status = "‚úÖ" if result["passed"] else "‚ùå"
        print(f"{status} {desc}")
        if not result["passed"]:
            print(f"   Input:    '{inp}'")
            print(f"   Expected: '{exp}'")
            print(f"   Actual:   '{result['actual']}'")
        print()

    # ============================================
    # SUMMARY
    # ============================================
    print("\n" + "=" * 70)

    passed = sum(1 for r in results if r["passed"])
    total = len(results)
    success_rate = round((passed / total) * 100, 2)

    print(f"üìä RESULTS: {passed}/{total} passed ({success_rate}%)")

    # Break down by category
    is_are_passed = sum(1 for r in results[:8] if r["passed"])
    article_passed = sum(1 for r in results[8:15] if r["passed"])
    combined_passed = sum(1 for r in results[15:] if r["passed"])

    print(f"\n   is/are agreement: {is_are_passed}/8")
    print(f"   Missing articles: {article_passed}/7")
    print(f"   Combined: {combined_passed}/3")

    print("\n" + "=" * 70)

    if success_rate == 100:
        print("‚úÖ ALL HEURISTICS WORKING PERFECTLY")
    elif success_rate >= 80:
        print("‚ö†Ô∏è  MOST HEURISTICS WORK - Some edge cases need fixing")
    else:
        print("‚ùå HEURISTICS NEED WORK")

    print("=" * 70 + "\n")

    # Save detailed results
    with open("GRAMMAR_HEURISTICS_TEST.json", "w", encoding="utf-8") as f:
        json.dump({
            "timestamp": datetime.now().isoformat(),
            "summary": {
                "total": total,
                "passed": passed,
                "success_rate": success_rate,
                "by_category": {
                    "is_are_agreement": f"{is_are_passed}/8",
                    "missing_articles": f"{article_passed}/7",
                    "combined": f"{combined_passed}/3"
                }
            },
            "results": results
        }, f, indent=2, ensure_ascii=False)

    print("üíæ Detailed results saved to: GRAMMAR_HEURISTICS_TEST.json\n")


if __name__ == "__main__":
    try:
        # Quick health check
        r = requests.get("http://127.0.0.1:5000/health", timeout=5)
        if r.status_code != 200:
            print("‚ùå Server not healthy")
            exit(1)
    except:
        print("‚ùå Server not running at http://127.0.0.1:5000")
        print("Start it with: python app.py")
        exit(1)

    main()

======================================================================
FILE: tests/production_benchmark.py
======================================================================

"""
production_benchmark.py
========================
Quick benchmark to answer: "Can I launch this and make money?"

Tests ONLY what matters:
1. Is it fast enough? (< 500ms average)
2. Can it handle 10 concurrent users? (basic load)
3. Does batch work? (for commercial customers)
4. Any crashes? (stability)

Run time: ~30 seconds
"""

import requests
import time
import statistics
from concurrent.futures import ThreadPoolExecutor
from datetime import datetime

API_URL = "http://127.0.0.1:5000"

# Test texts (realistic user inputs)
TESTS = [
    "i dont think this is corect",
    "she dont know where he goed",
    "this are bad sentence",
    "your going to love this",
    "their happy about the news",
]


def test_single_request(text):
    """Single request - measure time"""
    start = time.time()
    try:
        r = requests.post(f"{API_URL}/correct", json={"text": text}, timeout=10)
        ms = (time.time() - start) * 1000
        return {
            "success": r.status_code == 200,
            "time_ms": ms,
            "error": None
        }
    except Exception as e:
        return {
            "success": False,
            "time_ms": 0,
            "error": str(e)
        }


def test_batch_request(texts):
    """Batch request"""
    start = time.time()
    try:
        r = requests.post(f"{API_URL}/correct/batch", json={"texts": texts}, timeout=30)
        ms = (time.time() - start) * 1000
        return {
            "success": r.status_code == 200,
            "time_ms": ms,
            "error": None
        }
    except Exception as e:
        return {
            "success": False,
            "time_ms": 0,
            "error": str(e)
        }


def run_benchmark():
    print("\n" + "=" * 60)
    print("‚ö° PRODUCTION READINESS BENCHMARK")
    print("=" * 60 + "\n")

    results = {
        "timestamp": datetime.now().isoformat(),
        "tests": {},
        "verdict": ""
    }

    # ============================================
    # TEST 1: Response Time (Critical)
    # ============================================
    print("1Ô∏è‚É£  Response Time Test (20 requests)...")

    times = []
    failures = 0

    for i in range(20):
        text = TESTS[i % len(TESTS)]
        result = test_single_request(text)

        if result["success"]:
            times.append(result["time_ms"])
        else:
            failures += 1
            print(f"   ‚úó Request {i + 1} failed: {result['error']}")

    if times:
        avg_time = statistics.mean(times)
        p95_time = sorted(times)[int(len(times) * 0.95)]

        results["tests"]["response_time"] = {
            "avg_ms": round(avg_time, 2),
            "p95_ms": round(p95_time, 2),
            "min_ms": round(min(times), 2),
            "max_ms": round(max(times), 2),
            "failures": failures,
            "passed": avg_time < 500 and failures == 0
        }

        print(f"   ‚úì Average: {avg_time:.0f}ms")
        print(f"   ‚úì 95th percentile: {p95_time:.0f}ms")
        print(f"   ‚úì Range: {min(times):.0f}ms - {max(times):.0f}ms")

        if avg_time < 500:
            print(f"   ‚úÖ PASS - Fast enough for production")
        else:
            print(f"   ‚ö†Ô∏è  WARNING - Slower than ideal (>500ms avg)")
    else:
        results["tests"]["response_time"] = {"passed": False, "error": "All requests failed"}
        print("   ‚ùå FAIL - All requests failed")

    # ============================================
    # TEST 2: Concurrent Users (Critical)
    # ============================================
    print("\n2Ô∏è‚É£  Concurrency Test (10 simultaneous users)...")

    def concurrent_request(i):
        text = TESTS[i % len(TESTS)]
        return test_single_request(text)

    start = time.time()
    with ThreadPoolExecutor(max_workers=10) as executor:
        concurrent_results = list(executor.map(concurrent_request, range(10)))
    total_time = (time.time() - start) * 1000

    concurrent_times = [r["time_ms"] for r in concurrent_results if r["success"]]
    concurrent_failures = sum(1 for r in concurrent_results if not r["success"])

    if concurrent_times:
        results["tests"]["concurrency"] = {
            "total_time_ms": round(total_time, 2),
            "avg_request_ms": round(statistics.mean(concurrent_times), 2),
            "failures": concurrent_failures,
            "passed": concurrent_failures == 0
        }

        print(f"   ‚úì Completed in: {total_time:.0f}ms")
        print(f"   ‚úì Avg per request: {statistics.mean(concurrent_times):.0f}ms")
        print(f"   ‚úì Failures: {concurrent_failures}")

        if concurrent_failures == 0:
            print(f"   ‚úÖ PASS - Can handle concurrent users")
        else:
            print(f"   ‚ùå FAIL - {concurrent_failures} requests failed under load")
    else:
        results["tests"]["concurrency"] = {"passed": False, "error": "All concurrent requests failed"}
        print("   ‚ùå FAIL - Cannot handle concurrent load")

    # ============================================
    # TEST 3: Batch Processing (Commercial)
    # ============================================
    print("\n3Ô∏è‚É£  Batch Processing Test (50 texts)...")

    batch_texts = TESTS * 10  # 50 texts
    batch_result = test_batch_request(batch_texts)

    if batch_result["success"]:
        per_text = batch_result["time_ms"] / len(batch_texts)

        results["tests"]["batch"] = {
            "batch_size": len(batch_texts),
            "total_time_ms": round(batch_result["time_ms"], 2),
            "time_per_text_ms": round(per_text, 2),
            "passed": True
        }

        print(f"   ‚úì Batch of {len(batch_texts)} texts: {batch_result['time_ms']:.0f}ms")
        print(f"   ‚úì Per text: {per_text:.0f}ms")
        print(f"   ‚úÖ PASS - Batch processing works")
    else:
        results["tests"]["batch"] = {"passed": False, "error": batch_result["error"]}
        print(f"   ‚ùå FAIL - Batch processing failed: {batch_result['error']}")

    # ============================================
    # TEST 4: Error Handling (Stability)
    # ============================================
    print("\n4Ô∏è‚É£  Error Handling Test...")

    error_tests = [
        ("Empty text", {"text": ""}),
        ("Missing field", {"wrong": "field"}),
        ("Long text", {"text": "x" * 60000}),
    ]

    error_handling_ok = True
    for name, payload in error_tests:
        try:
            r = requests.post(f"{API_URL}/correct", json=payload, timeout=10)
            # We expect 4xx errors, not crashes
            if r.status_code >= 500:
                print(f"   ‚úó {name}: Server crashed (500)")
                error_handling_ok = False
            else:
                print(f"   ‚úì {name}: Handled correctly ({r.status_code})")
        except Exception as e:
            print(f"   ‚úó {name}: Connection failed")
            error_handling_ok = False

    results["tests"]["error_handling"] = {"passed": error_handling_ok}

    if error_handling_ok:
        print(f"   ‚úÖ PASS - Errors handled gracefully")
    else:
        print(f"   ‚ùå FAIL - Server crashes on bad input")

    # ============================================
    # FINAL VERDICT
    # ============================================
    print("\n" + "=" * 60)

    all_passed = all(
        test.get("passed", False)
        for test in results["tests"].values()
    )

    if all_passed:
        verdict = "‚úÖ READY FOR PRODUCTION"
        verdict_detail = "All critical tests passed. You can launch."
        results["verdict"] = "PASS"
    else:
        failed_tests = [
            name for name, test in results["tests"].items()
            if not test.get("passed", False)
        ]
        verdict = "‚ö†Ô∏è  NEEDS ATTENTION"
        verdict_detail = f"Failed: {', '.join(failed_tests)}"
        results["verdict"] = "FAIL"

    print(f"VERDICT: {verdict}")
    print(f"Details: {verdict_detail}")
    print("=" * 60 + "\n")

    # Save detailed results
    import json
    with open("PRODUCTION_BENCHMARK.json", "w") as f:
        json.dump(results, f, indent=2)

    print("üìä Full results saved to: PRODUCTION_BENCHMARK.json\n")

    return results


if __name__ == "__main__":
    try:
        # Quick health check first
        r = requests.get(f"{API_URL}/health", timeout=5)
        if r.status_code != 200:
            print("‚ùå Server not healthy. Check /health endpoint.")
            exit(1)
    except:
        print("‚ùå Server not running at", API_URL)
        print("Start it with: python app.py")
        exit(1)

    run_benchmark()

======================================================================
FILE: tests/test_word_order_fix.py
======================================================================

# test_word_order_fix.py
import requests


def test_word_order():
    tests = [
        ("yesterday i go to store", "Yesterday I went to store"),  # ‚úÖ OVO JE ISPRAVNO
        ("always he is late", "He always is late"),
        ("i tomorrow will go", "I will go tomorrow"),
    ]

    for input_text, expected in tests:
        response = requests.post("http://127.0.0.1:5000/correct", json={"text": input_text})
        actual = response.json().get("corrected", "")
        passed = actual.strip() == expected.strip()
        print(f"{'‚úÖ' if passed else '‚ùå'} '{input_text}' ‚Üí '{actual}'")
        if not passed:
            print(f"   Expected: '{expected}'")


if __name__ == "__main__":
    test_word_order()